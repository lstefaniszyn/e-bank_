#https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/maven?view=azure-devops
#https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/cache?view=azure-devops
trigger:
- main
variables:
  - name: container_image
    value: maven:3.6.3-openjdk-11
pool:
  vmImage: 'Ubuntu-latest'
stages:
  - stage: 'package'
    displayName: 'Build, test, scan and create docker image with app'
    jobs:
      - job: 'compile'
        container: ${{ variables.container_image }}
        displayName: 'Compile and test'
        steps:
          - task: Maven@3
            displayName: 'Compile'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'compile test-compile'
              publishJUnitResults: false

          - task: Maven@3
            displayName: 'Test'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              publishJUnitResults: true
              testResultsFiles: 'target/surefire-reports/*.xml'

      - job: 'static'
        container: ${{ variables.container_image }}
        displayName: 'Static analysis and security scan'
        dependsOn: 'compile'
        steps:
        - task: Maven@3
          displayName: 'Static analysis'
          inputs:
            mavenPomFile: 'pom.xml'
            options: '-P static-analysis'
            goals: 'test'
            publishJUnitResults: false
        # TODO: tu powinno byÄ‡ zbieranie raportu z jacoco ale go nie ma
        - task: PublishCodeCoverageResults@1
          inputs:
            codeCoverageTool: JaCoCo
            summaryFileLocation: $(System.DefaultWorkingDirectory)/target/jacoco.exec
            reportdDirectory: $(System.DefaultWorkingDirectory)/target/site/jacoco/
        - publish: $(System.DefaultWorkingDirectory)/target/site/pmd.html
          artifact: 'PMD report'
      - job: 'integration'
        container: ${{ variables.container_image }}
        displayName: 'Integration tests'
        dependsOn: 'static'
        continueOnError: true
        steps:
        - task: Maven@3
          displayName: 'Run integration tests'
          inputs:
            mavenPomFile: 'pom.xml'
            options: '-Dskip.surefire.tests=true'
            goals: 'verify'
            publishJUnitResults: true
            testResultsFiles: 'target/failsafe-reports/*.xml'
      - job: 'package'
        container: ${{ variables.container_image }}
        displayName: 'Packaging software'
        dependsOn: 'integration'
        steps:
        - task: Maven@3
          displayName: 'Build package'
          inputs:
            mavenPomFile: 'pom.xml'
            options: '-DskipTests=true'
            goals: 'package'
            publishJUnitResults: false
        #cannot call a docker from inside a docker
        # - task: Docker@2
        #   displayName: 'Build docker imgae'
        #   inputs:
        #     command: build
        #     tags: |
        #       latest
        #     dockerfile: ./docker/Dockerfile
        #     repository: ebank